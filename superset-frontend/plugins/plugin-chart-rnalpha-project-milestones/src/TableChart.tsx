import React, { useEffect, useRef, useState } from 'react';
import { DataRecord } from '@superset-ui/core';
import { TableChartTransformedProps } from './types';
import { DataTableProps } from './DataTable';
import { Styles, StyledTextArea } from './styles';

export function autoResize(element: HTMLTextAreaElement) {
  if (element) {
    element.style.height = 'auto'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
    element.style.height = `${element.scrollHeight}px`; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤—ã—Å–æ—Ç—É
  }
}

// –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
const mockData = [
  { PROJ_ID: '12345', project_name: 'Project Alpha' },
  { PROJ_ID: '67890', project_name: 'Project Beta' },
];

const mockApiResponse = {
  data: [
    { text: '–°–æ–±—ã—Ç–∏–µ 1', milestone_date: '2025-02-26' },
    { text: '–°–æ–±—ã—Ç–∏–µ 2', milestone_date: '2025-03-15' },
  ],
};

export default function TableChart<D extends DataRecord = DataRecord>(
  props: TableChartTransformedProps<D> & {
    sticky?: DataTableProps<D>['sticky'];
  },
) {
  const { height, width, data: initialData } = props;
  const [data, setData] = useState<D[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [editedData, setEditedData] = useState<D[]>([]);
  const textAreasRef = useRef<(HTMLTextAreaElement | null)[]>([]);
  const [projId, setProjId] = useState<string | null>(null);

  useEffect(() => {
    // TODO mockDATA
    if (mockData.length > 0) {
      const firstProjId = mockData[0].PROJ_ID; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π PROJ_ID
      setProjId(firstProjId);
      setData(mockApiResponse.data);
      setEditedData(mockApiResponse.data);
      handleLoadExternal(projId);
    }
    if (initialData.length > 0) {
      // const projId = initialData[0]?.PROJ_ID; // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π PROJ_ID
      // if (projId) {
      //   handleLoadExternal(projId);
      // } else {
      //   console.warn('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω PROJ_ID –≤ initialData');
      // }
    }
  }, [initialData]); // –í—ã–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ initialData

  useEffect(() => {
    // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å–∞–π–∑–∏–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏
    textAreasRef.current.forEach((textarea) => {
      if (textarea) autoResize(textarea);
    });
  }, [editedData]);

  // ========== GET-–ª–æ–≥–∏–∫–∞ ==========
  const handleLoadExternal = async (projId: string) => {
    setIsLoading(true);

    const url = `http://bnipi-rnc-tst1.rosneft.ru:8098/project/milestones?${projId}`;
    console.log(`üîó GET –∑–∞–ø—Ä–æ—Å: ${url}`);

    // –ü—Ä–∏–º–µ—Ä retry –≤ 5 –ø–æ–ø—ã—Ç–æ–∫
    const maxAttempts = 5;
    let attempts = 0;

    while (attempts < maxAttempts) {
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        });
        if (response.ok) {
          const dataFromGet = await response.json();
          setData(dataFromGet.data);
          console.log('‚úÖ –í–Ω–µ—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã');
          break; // –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
        } else {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ GET-–∑–∞–ø—Ä–æ—Å–µ, —Å—Ç–∞—Ç—É—Å:', response.status);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ GET-–∑–∞–ø—Ä–æ—Å–µ:', error);
      }
      attempts++;
      if (attempts < maxAttempts) {
        console.log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ GET-–∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã... (${attempts}/${maxAttempts})`);
        await new Promise(res => setTimeout(res, 2000));
      } else {
        console.error('‚ùå GET-–∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–µ—É–¥–∞—á–Ω–æ –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫');
      }
    }

    setIsLoading(false);
  };

  // ========== PATCH-–ª–æ–≥–∏–∫–∞ ==========
  const handleSave = async () => {
    if (!projId) {
      console.error('‚ùå –û—à–∏–±–∫–∞: PROJ_ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    const requestBody = {
      proj_id: projId,
      data: editedData,
    };

    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', requestBody);

    const url = `http://bnipi-rnc-tst1.rosneft.ru:8098/project/milestones`;


    try {
      const response = await fetch(url, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: requestBody }),
      });

      if (response.ok) {
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
      } else {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ PATCH-–∑–∞–ø—Ä–æ—Å–µ, —Å—Ç–∞—Ç—É—Å:', response.status);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ PATCH-–∑–∞–ø—Ä–æ—Å–µ:', error);
    }
  };

  // ========== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ==========
  const handleChange = (index: number, field: string, value: string) => {
    const updatedData = [...editedData];
    updatedData[index] = { ...updatedData[index], [field]: value };
    setEditedData(updatedData);
  }

  return (
    <Styles height={height} width={width}>
      {isLoading ? <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p> : null}
      <button onClick={handleSave}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <table>
        <thead>
          <tr>
            <th>–¢–µ–∫—Å—Ç</th>
            <th>–î–∞—Ç–∞</th>
          </tr>
        </thead>
        <tbody>
          {editedData.map((row, rowIndex) => (
            <tr key={rowIndex}>
              <td>
                <StyledTextArea
                  ref={(el) => (textAreasRef.current[rowIndex] = el)}
                  value={row.text}
                  onChange={(e) => {
                    handleChange(rowIndex, 'text', e.target.value);
                    autoResize(e.target);
                  }}
                />
              </td>
              <td>
                <StyledTextArea
                  ref={(el) => (textAreasRef.current[rowIndex + editedData.length] = el)}
                  value={row.milestone_date}
                  onChange={(e) => {
                    handleChange(rowIndex, 'milestone_date', e.target.value);
                    autoResize(e.target);
                  }}
                />
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </Styles>
  );
}
